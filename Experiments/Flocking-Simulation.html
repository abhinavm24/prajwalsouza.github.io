<html>
	<head>
		<title> Flocking Simulation </title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script src="https://cdn.rawgit.com/prajwalsouza/QLearning/39137c9a/physicsjs-full.min.js" type="text/javascript"></script>
		<script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		  ga('create', 'UA-103589215-2', 'auto');
		  ga('send', 'pageview');
		</script>
	</head>
	<body style='margin:0px;'>

		<div id='titleAndDescription' height="100%" width="100%" style='z-index:1; position: relative;cursor:crosshair;'>
			<div height="100%" width="100%" style='z-index:1; position: relative;'>
				<svg id='descriptContents' height="100%" width="100%" >
					<text x="50%" y="40%" fill="black" font-family="Calibri" style='font-size:28px;font-size: 2.8vw;' text-anchor="middle"> Flocking Behaviour </text>
					<a href="https://en.wikipedia.org/wiki/Flocking_(behavior)" target="_blank">
					<text id="description" x="50%" y="45%" fill="rgba(255,140,0,1)" font-family="Calibri" style='font-size:18px;font-size: 1.6vw; cursor:pointer;' text-anchor="middle"> Developed using PhysicsJS, Demonstates the Flocking Algorithm (Boids) </text>
					</a>
					<text id="workingOf" x="50%" y="50%" fill="rgba(140,0,255,1)" font-family="Calibri" style='font-size:15px;font-size: 1.4vw;' text-anchor="middle"> Individuals maintain separation between them. They steer towards the average direction of their neighbours. </text>
					<text id="addIndividualButton" x="50%" y="60%" fill="rgba(0,140,255,1)" font-family="Calibri" style='font-size:18px;font-size: 1.5vw; cursor:pointer;' text-anchor="middle"> Add Individual </text>
					<text id="addObstacleButton" x="50%" y="65%" fill="black" font-family="Calibri" style='font-size:18px;font-size: 1.5vw; cursor:pointer;' text-anchor="middle"> Add Obstacle</text>
					<text id="clearIndividualsButton" x="50%" y="70%" fill="black" font-family="Calibri" style='font-size:18px;font-size: 1.5vw; cursor:pointer;' text-anchor="middle">Clear Individuals</text>
					<text id="clearObstaclesButton" x="50%" y="75%" fill="black" font-family="Calibri" style='font-size:18px;font-size: 1.5vw; cursor:pointer;' text-anchor="middle">Clear Obstacles</text>
					<a href="https://prajwalsouza.github.io" target="_blank">
					<text id="linkToMain" x="50%" y="90%" fill="rgba(0,140,255,0.6)" font-family="Calibri" style='font-size:18px;font-size: 1.2vw; cursor:pointer;' text-anchor="middle">prajwalsouza.github.io</text>
					</a>



				</svg>
			</div>
			
		</div>



		
		
		
		
		<script> 



		var canvaswidth = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
		var canvasheight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;

		// Above Inner Window Size code from https://stackoverflow.com/a/28241682

		canvaswidth = canvaswidth; 
		// To deal with the extra width from the window Innerwith function
		canvasheight = canvasheight;


		addIndividualMode = 1;
		addObstacleMode = 0;

		function changeAddIndividualMode(event) {
			if (addIndividualMode == 1) {
				addIndividualMode = 0;
				document.getElementById('addIndividualButton').style.fill = 'rgba(0,0,0,1)'
			}
			else if (addIndividualMode == 0) {
				addIndividualMode = 1;
				document.getElementById('addIndividualButton').style.fill = 'rgba(0,140,255,1)'
				addObstacleMode = 0;	
				document.getElementById('addObstacleButton').style.fill = 'rgba(0,0,0,1)'

			}
		}

		function changeAddObstacleMode(event) {
			if (addObstacleMode == 1) {
				addObstacleMode = 0;
				document.getElementById('addObstacleButton').style.fill = 'rgba(0,0,0,1)'
			}
			else if (addObstacleMode == 0) {
				addObstacleMode = 1;
				document.getElementById('addObstacleButton').style.fill = 'rgba(0,140,255,1)'

				addIndividualMode = 0;
				document.getElementById('addIndividualButton').style.fill = 'rgba(0,0,0,1)'
			}
		}

		document.getElementById('addIndividualButton').addEventListener('click', changeAddIndividualMode)
		document.getElementById('addObstacleButton').addEventListener('click', changeAddObstacleMode)

		




		Physics(function(world){

		var viewWidth = canvaswidth;
		var viewHeight = canvasheight;

		

		var renderer = Physics.renderer('canvas', {
			el: 'viewport',
			width: viewWidth,
			height: viewHeight,
			meta: false, // don't display meta data
			styles: {
				// set colors for the circle bodies
				'circle' : {
					strokeStyle: '#351024',
					lineWidth: 1,
					fillStyle: '#027FFC'
				},
				'rectangle' : {
					fillStyle: 'rgba(130, 8, 251, 0.29)',
					strokeStyle: 'rgba(130, 8, 251, 0)'
				}
			}
		});

		


		// add the renderer
		world.add(renderer);
		// render on each step
		world.on('step', function(){
			world.render();
			
		});


	
		// bounds of the window
		var viewportBounds = Physics.aabb(0, 0, viewWidth, viewHeight);


		//constrain objects to these bounds
		world.add(Physics.behavior('edge-collision-detection', {
			aabb: viewportBounds,
			restitution: 0.99,
			cof: 0.99
		}));

		
		
		// ensure objects bounce when edge collision is detected
		world.add(Physics.behavior('body-impulse-response') );
		collisiondetect = Physics.behavior('body-collision-detection')
		world.add( collisiondetect );
		world.add( Physics.behavior('sweep-prune') );

		

		world.add(Physics.behavior('interactive', { el: renderer.container }));


		function removeIndividuals(event) {
			for (i = 0; i < objectIDs.length; i ++) {
				world.removeBody(objectIDs[i])
			}
			objectIDs = []

		}

		document.getElementById('clearIndividualsButton').addEventListener('click', removeIndividuals)


		function removeObstacles(event) {
			for (i = 0; i < obstacleIDs.length; i ++) {
				world.removeBody(obstacleIDs[i])
			}
			obstacleIDs = []

		}

		document.getElementById('clearObstaclesButton').addEventListener('click', removeObstacles)




		objectIDs = []

		obstacleIDs = []


		// Add some Individuals

		for (k = 0; k < 50; k++) {
			individual = Physics.body('circle', {
				x: Math.random()*viewWidth, // x-coordinate
				y: Math.random()*viewHeight, // y-coordinate
				mass: 1,
				vx: (Math.random() - 0.5)*0.4, // velocity in x-direction
				vy: (Math.random() - 0.5)*0.4, // velocity in y-direction
				radius: 2,
				styles: {
					fillStyle: 'rgba(0,140,255,0.6)'
				}
			})


			world.add(individual);

			objectIDs.push(individual)
		}


		world.on({
			'interact:poke': function( pos ){
				world.wakeUpAll();

				if (addIndividualMode == 1) {
					individual = Physics.body('circle', {
						x: event.clientX, // x-coordinate
						y: event.clientY, // y-coordinate
						mass: 1,
						vx: (Math.random() - 0.5)*0.4, // velocity in x-direction
						vy: (Math.random() - 0.5)*0.4, // velocity in y-direction
						radius: 2,
						styles: {
							fillStyle: 'rgba(0,140,255,0.6)'
						}
					})


					world.add(individual);

					objectIDs.push(individual)

				}
				else if(addObstacleMode == 1) {
					theball = Physics.body('circle', {
						x: event.clientX, // x-coordinate
						y: event.clientY, // y-coordinate
						vx: 0, // velocity in x-direction
						vy: 0, // velocity in y-direction
						treatment: 'static',
						mass: 1,
						radius: 50,
						styles: {
							fillStyle: 'rgba(140,255,0,0.2)'
						}
					});

					world.add(theball);

					obstacleIDs.push(theball)
				}
			}
			,'interact:move': function( pos ){
			}
			,'interact:grab': function( data ){
				
			}
			,'interact:release': function(){
				world.wakeUpAll();
			}
		});

		
		xdiv = 7
		ydiv = 7

		blockData = {}
		xblocklength = parseInt(viewWidth/xdiv);
		yblocklength = parseInt(viewHeight/ydiv);

		avgblocklength = (xblocklength + yblocklength) / 15;

		world.add(Physics.behavior('newtonian', { max: avgblocklength, strength: -1}))

		function makeBlocks() {
			blockData = {}
			for (i = 0; i <= 9; i++) {
				for (j = 0; j <= 9; j++) {
					blockData[i + '-' + j] = []
				}
			}
		}


		function coordToBlockValue(xval, yval) {
			ival = parseInt(xval/xblocklength)
			jval = parseInt(yval/yblocklength)
			if (ival == xdiv) {
				ival = xdiv - 1;
			}
			if (jval == ydiv) {
				jval = ydiv - 1;
			}
			return [ival,jval]
		}

		function assignBlocks() {
			makeBlocks();
			for (k = 0; k < objectIDs.length; k++) {
				objectOfInterest = objectIDs[k];
				blockCoords = coordToBlockValue(objectOfInterest.state.pos.x,objectOfInterest.state.pos.y);
				blockData[blockCoords[0] + '-' + blockCoords[1]].push(objectOfInterest)
			}
		}


		function applySwarmAlgorithm() {
			if (objectIDs.length != 0) {
				for (p=0; p<objectIDs.length; p++) {
					chosenbody = objectIDs[p];
					coordsX = chosenbody.state.pos.x;
					coordsY = chosenbody.state.pos.y;
					bCoordvalues = coordToBlockValue(coordsX,coordsY)
					neighbours = blockData[bCoordvalues[0] + '-' + bCoordvalues[1]]

					avgVx = 0;
					avgVy = 0;

					for (m = 0; m < neighbours.length; m++) {
						if (neighbours[m] != chosenbody) {
							neighbourvel = neighbours[m].state.vel;
							avgVy = avgVy + neighbourvel.y;
							avgVx = avgVx + neighbourvel.x;
						}
					}

					velocityToAdjustToX = avgVx/neighbours.length
					velocityToAdjustToY = avgVy/neighbours.length

					scale = 0.05

					chosenbody.applyForce(Physics.vector( velocityToAdjustToX*scale, velocityToAdjustToY*scale));

					currentvelocity = chosenbody.state.vel;
					if (currentvelocity.norm() > 0.11) {
						speedfactor = 0.11/currentvelocity.norm();
						chosenbody.state.vel = chosenbody.state.vel.mult(speedfactor);
					}

				}

			}
		}


		// subscribe to ticker to advance the simulation
		timestepcount = 0;


		Physics.util.ticker.on(function( time, dt ){
			timestepcount = timestepcount + 1;
			world.step(time);
			if (timestepcount % 5 == 0) {
				assignBlocks();
				applySwarmAlgorithm();
			}
			
			
		});



		// start the ticker
		Physics.util.ticker.start();

		});
			
		document.getElementById('viewport').style.height = '100%'; // Fixing a bug in the library for Mozilla.
		document.getElementById('viewport').style.width = '100%';
		document.getElementById('viewport').style.left = '0%';
		document.getElementById('viewport').style.right = '0%';
		document.getElementById('viewport').style.bottom = '0%';
		document.getElementById('viewport').style.top = '0%';
		document.getElementById('viewport').style.zIndex = '0';
		
		</script>



	</body>
<html>
